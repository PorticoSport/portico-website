---
import "photoswipe/style.css";
import Section from "@/shared/components/Section.astro";
import Button from "./Button.astro";
import { type Photo } from "@/types/types.ts";

interface Props {
  id: string;
  heading?: string;
  subheading?: string;
  offset?: number;
  photos: Photo[];
  path: string;
  loadMoreText?: string;
  urlButton?: string;
  urlText?: string;
  buttonTitle?: string;
}

const {
  id,
  heading,
  subheading,
  offset = 9,
  photos = [],
  path = "",
  loadMoreText,
  urlButton,
  urlText,
  buttonTitle,
} = Astro.props;

// No necesitamos ofuscar, solo guardar la ruta
---

<Section id={id} heading={heading} subheading={subheading}>
  <masonry-layout
    gap="24"
    maxcolwidth="600"
    class="lg:mx-auto py-20"
    id="gallery"
  >
    {
      photos.slice(0, offset).map(({ src, width, height, alt }: Photo) => (
        <div
          class="gallery-item group rounded-xl hover:scale-105 hover:contrast-[110%] transition-all relative block overflow-hidden cursor-zoom-in"
          data-pswp-src={`/${path}/${src}`}
          data-cropped="true"
          data-pswp-width={width}
          data-pswp-height={height}
        >
          <img
            class="rounded-xl w-full h-auto block"
            loading="lazy"
            src={`/${path}/${src}`}
            alt={alt}
            width={width}
            height={height}
          />
          <img
            class="img-effect blur-md opacity-0 group-hover:opacity-100 absolute inset-0 transition contrast-150 -z-10 w-full h-full object-cover"
            loading="lazy"
            src={`/${path}/${src}`}
            alt={alt}
            width={width}
            height={height}
          />
          <span class="absolute bottom-0 left-0 right-0 p-4 text-white bg-black bg-opacity-50 rounded-b-xl">
            {alt}
          </span>
        </div>
      ))
    }
  </masonry-layout>

  {
    urlButton && urlText ? (
      <div class="text-center mt-12">
        <Button url={urlButton} target="_self" class="text-sm md:text-base" title={buttonTitle}>
          {urlText}
        </Button>
      </div>
    ) : null
  }

  {
    loadMoreText && photos.length > offset ? (
      <div class="text-center mx-auto">
        <Button id="load-more" url="#">
          {loadMoreText}
        </Button>
      </div>
    ) : null
  }
</Section>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "@appnest/masonry-layout";

  document.addEventListener("astro:page-load", () => {
    // Inicializar PhotoSwipe con configuraci칩n custom
    const lightbox = new PhotoSwipeLightbox({
      gallery: "#gallery",
      children: ".gallery-item",
      pswpModule: () => import("photoswipe"),
      // A침adir funci칩n para obtener el thumbnail correcto
      thumbSelector: ".gallery-item img:first-child",
    });

    // Filtro para construir correctamente los datos de cada item
    lightbox.addFilter('itemData', (itemData, index) => {
      const element = document.querySelectorAll("#gallery .gallery-item")[index];
      const imgSrc = element.getAttribute('data-pswp-src');
      const width = element.getAttribute('data-pswp-width');
      const height = element.getAttribute('data-pswp-height');
      const img = element.querySelector('img:first-child');
      
      if (imgSrc) {
        itemData.src = imgSrc;
        itemData.w = parseInt(width);
        itemData.h = parseInt(height);
        itemData.msrc = img?.src; // miniatura para la transici칩n
      }
      
      return itemData;
    });

    lightbox.init();
  });
</script>

<script is:inline define:vars={{ photos, offset, path }}>
  document.addEventListener("astro:page-load", () => {
    const $button = document.querySelector("#load-more");
    const $first = document.querySelector("#gallery .gallery-item:first-child");

    $button?.addEventListener("click", async (e) => {
      $button.remove();
      e.preventDefault();

      const html = photos
        .slice(offset)
        .map((img) => {
          const $clone = $first?.cloneNode(true);

          $clone.setAttribute("data-pswp-width", img.width);
          $clone.setAttribute("data-pswp-height", img.height);
          $clone.setAttribute("data-pswp-src", `/${path}/${img.src}`);
          $clone.classList.add("animate-fade-up");
          $clone.classList.add("animate-delay-300");
          $clone.classList.add("opacity-0");
          $clone.querySelector("img:first-child").setAttribute("src", `/${path}/thumbnails/${img.src}`)
          $clone.querySelector("img:first-child").setAttribute("width", img.width)
          $clone.querySelector("img:first-child").setAttribute("height", img.height)
          $clone.querySelector("img:first-child").setAttribute("alt", img.alt)
          $clone.querySelector("img:first-child + img").setAttribute("width", img.width)
          $clone.querySelector("img:first-child + img").setAttribute("height", img.height)
          $clone.querySelector("img:first-child + img").setAttribute("alt", img.alt)
          $clone.querySelector("img:first-child + img").setAttribute("src", `/${path}/thumbnails/${img.src}`)
          $clone.querySelector("span:last-child").innerHTML = img.alt;
          return $clone?.outerHTML;
        })
        .join("");

      document.querySelector("#gallery")?.insertAdjacentHTML("beforeend", html);
      document.querySelector("masonry-layout").scheduleLayout();
    });
  });
</script>

<style is:global>
  .pswp {
    --pswp-bg: #00012a;
  }

  .pswp__img {
    @apply rounded-xl;
    max-width: 80vw !important;
    max-height: 80vh !important;
    margin-left: 32px;
    margin-top: 60px;
  }

  @media (max-width: 768px) {
    .pswp__img {
      margin-top: 0 !important;
    }
  }

  #gallery .gallery-item {
    cursor: zoom-in;
    aspect-ratio: auto;
  }

  @media (prefers-reduced-motion: no-preference) {
    masonry-layout img {
      scale: 0.8;
      opacity: 0;
      animation: fade-in linear forwards;
      animation-timeline: view();
      animation-range: entry 100px;
    }

    @keyframes fade-in {
      to {
        scale: 1;
        opacity: 1;
      }
    }
  }
</style>
