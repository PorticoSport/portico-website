---
import { capitalize } from "@/libraries/utils";

const pathname = Astro.url.pathname; // ej: "/usa/newyork"
const segments = pathname.split("/").filter(Boolean);

const crumbs = [
  {
    label: "Padel court builders",
    href: "/",
  },
  ...segments.map((segment, index) => ({
    label: capitalize(segment),
    href: "/" + segments.slice(0, index + 1).join("/"),
  })),
];
---

<nav class="w-full max-w-[1400px] mx-auto md:text-xl text-left px-6 md:px-12 lg:px-20 mt-4">
  <ul class="flex flex-row gap-2" id="breadcrumb-list">
    {crumbs.map((crumb, index) => (
      <li class="flex gap-1 items-center py-10">
        {index < crumbs.length - 1 ? (
          <>
            <a
              href={crumb.href}
              data-breadcrumb={crumb.href}
              class="text-secondary hover:text-current focus:text-current text__glowing transition-colors"
            >
              {crumb.label}
            </a>

            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m9 18 6-6-6-6" />
            </svg>
          </>
        ) : (
          <span
            id="page-title-breadcrumb"
            class="text-secondary text__glowing transition-colors line-clamp-1"
          ></span>
        )}
      </li>
    ))}
  </ul>
</nav>

<script>
  async function fetchTitleCached(url) {
    const cacheKey = "breadcrumb:" + url;
    const cached = localStorage.getItem(cacheKey);

    if (cached) return cached;

    try {
      const res = await fetch(url);
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");

      const title = doc.querySelector("h1")?.textContent || "";

      if (title) {
        localStorage.setItem(cacheKey, title);
      }

      return title;
    } catch {
      return "";
    }
  }

  async function updateBreadcrumbs() {
    const links = document.querySelectorAll("#breadcrumb-list a");

    for (const link of links) {
      const title = await fetchTitleCached(link.dataset.breadcrumb);
      if (title) {
        link.textContent = title;
      }
    }

    // Último crumb = h1 actual
    const h1 = document.querySelector("h1");
    const currentCrumb = document.getElementById("page-title-breadcrumb");

    if (h1 && currentCrumb) {
      currentCrumb.textContent = h1.textContent;
      currentCrumb.setAttribute("title", h1.textContent);
    }
  }

  function waitForH1AndUpdate() {
    const currentCrumb = document.getElementById("page-title-breadcrumb");

    const observer = new MutationObserver(() => {
      const h1 = document.querySelector("h1");

      if (h1 && currentCrumb) {
        currentCrumb.textContent = h1.textContent;
        currentCrumb.setAttribute("title", h1.textContent);
        observer.disconnect();
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  }

  // Inicialización normal
  document.addEventListener("DOMContentLoaded", () => {
    updateBreadcrumbs();
    waitForH1AndUpdate();
  });

  // Soporte SPA (Astro view transitions)
  document.addEventListener("astro:after-swap", () => {
    updateBreadcrumbs();
    waitForH1AndUpdate();
  });
</script>
