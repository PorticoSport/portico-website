---
import Layout from "@/shared/layouts/Layout.astro";
import Typography from "@/shared/components/ui/Typography.astro";
import Breadcrumb from "@/shared/components/Breadcrumb.astro";
import Section from "@/shared/components/Section.astro";
import AuthorBox from "@/shared/components/AuthorBox.astro";
import {
  getI18N,
  getCurrentLocale,
} from "@/shared/i18n";

interface Props {
  language: string;
  slug: string;
  BreadcrumLabel: string;
  BreadcrumbUrl: string;
}

const { language, slug, BreadcrumbUrl, BreadcrumLabel } = Astro.props;

const i18n = getI18N({ language });
const currentLocale = getCurrentLocale({ language });

function convertDate(dateToconvert: string) {
  return new Date(dateToconvert).toLocaleDateString(i18n.LOCALE_DATE, {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

/* =========================
  FETCH POST BY SLUG
========================= */

let post: any = null;

try {
  const response = await fetch(
    `https://portico.porticosport.com/wp-json/wp/v2/posts?slug=${slug}&_embed`,
    { cache: "force-cache" }
  );

  if (!response.ok) {
    console.error(`Error HTTP ${response.status}: ${await response.text()}`);
  } else {
    const data = await response.json();
    post = data[0];
  }
} catch (err) {
  console.error("Error en fetch:", err);
}

if (!post) {
  throw new Error("Post no encontrado");
}

/* =========================
  DATA EXTRACTION
========================= */

const {
  title: { rendered },
  date,
  yoast_head_json,
  content: { rendered: content },
  _embedded,
} = post;

const finalTitle = yoast_head_json?.title || rendered;
const description = yoast_head_json?.description || "";

const featuredMedia = _embedded?.["wp:featuredmedia"]?.[0];
const image = featuredMedia?.source_url || "";
const imgAlt = featuredMedia?.alt_text || "";

const author = _embedded?.author?.[0];
const authorName = author?.name;
const authorDescription = author?.description;
const authorSlug = author?.slug;
const avatar = author?.simple_local_avatar?.full;

const schemaGraph =
  author?.yoast_head_json?.schema?.["@graph"]?.slice(-1)?.[0];
const socialMedia = schemaGraph?.sameAs || [];

const finalDate = convertDate(date);
const dateISO = new Date(date).toISOString();

/* =========================
  SCHEMA.ORG
========================= */

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  headline: finalTitle,
  datePublished: dateISO,
  author: {
    "@type": "Person",
    name: authorName,
    url: `https://porticosport.com${i18n.PAGES.AUTHOR.ROUTE.URL}/${authorSlug}`,
  },
  publisher: {
    "@type": "Organization",
    name: "Portico Sport",
    logo: {
      "@type": "ImageObject",
      url: "https://porticosport.com/logo.png",
    },
  },
  image: image ? [image] : [],
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": `https://porticosport.com${i18n.PAGES.NEWS.ROUTE.URL}/${slug}`,
  },
};
---

<Layout
  title={finalTitle}
  description={description}
  currentLocale={currentLocale}
  language={language}
  bgImage={image}
  ogImage={image}
  bgClass="brightness-50"
  schema={articleSchema}
  robots="max-snippet:-1, max-image-preview:large, max-video-preview:-1"
>
  <main class="flex flex-col">
    <div
      class="text-center w-full min-h-[40rem] lg:aspect-video flex justify-center items-center flex-col gap-4 px-4"
    >
      <Typography
        tag="h1"
        className="uppercase mb-6 font-bold"
        text={rendered}
        responsive
      />
    </div>

    <div class="bg-main relative bg-background">
      <Breadcrumb
        crumbs={[
          {
            label: i18n.PAGES.HOME.ROUTE.BREADCRUMB,
            href: i18n.PAGES.HOME.ROUTE.URL,
          },
          {
            label: BreadcrumLabel,
            href: BreadcrumbUrl,
          },
          {
            label: finalTitle,
            href: `${i18n.PAGES.NEWS.ROUTE.URL}/${slug}`,
          },
        ]}
      />

      <Section>
        <p class="text-gray-500 mb-6">
          {i18n.PAGES.NEWS.POST_PAGE.WRITE}{" "}
          <a
            href={`${i18n.PAGES.AUTHOR.ROUTE.URL}/${authorSlug}`}
            class="hover:underline hover:text-primary duration-300"
          >
            {authorName}
          </a>
          <span class="date">{finalDate}</span>
        </p>

        <article set:html={content} class="content" />

        <AuthorBox
          slug={`${i18n.PAGES.AUTHOR.ROUTE.URL}/${authorSlug}`}
          className="mt-8"
          name={authorName}
          description={authorDescription}
          avatar={avatar}
          socialMedia={socialMedia}
          isBox
        />
      </Section>
    </div>
  </main>
</Layout>

<style>
  .date::before {
    content: " - ";
  }
</style>

<style is:global>
  .content a {
    @apply text-primary transition-colors;
  }

  .content a:hover {
    @apply text-secondary;
  }

  .wp-block-image {
    @apply my-8;
  }
</style>
