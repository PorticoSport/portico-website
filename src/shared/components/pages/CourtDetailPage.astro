---
export const prerender = true;
export const revalidate = 3600;

import { Image } from 'astro:assets';
import Layout from "@/shared/layouts/Layout.astro";
import SectionContact from "@/shared/components/sections/SectionContact.astro";
import SectionInformation from "@/shared/components/sections/SectionInformation.astro";
import SectionCourtsGrid from "@/shared/components/sections/SectionCourtsGrid.astro";
import SizingSection from "@/shared/components/sections/SizingSection.astro";
import Typography from "@/shared/components/ui/Typography.astro";
import BenefitsSection from "@/shared/components/sections/BenefitsSection.astro";
import TurfSection from "@/shared/components/sections/TurfSection.astro";
import LightSection from "@/shared/components/sections/LightSection.astro";
import NormativeLogos from "@/shared/components/sections/NormativeLogos.astro";
import Breadcrumb from "@/shared/components/Breadcrumb.astro";
import Button from "@/shared/components/Button.astro";
import Section from "@/shared/components/Section.astro";
import Video from "@/shared/components/Video.astro";
import Gallery from "../Gallery.astro";
import FeatureList from "@/shared/components/FeatureList.astro";
import SectionFaqs from "@/shared/components/sections/SectionFaqs.astro";
import { getI18N, getCurrentLocale } from "@/shared/i18n";
import { courtsGrid } from "@/shared/i18n/constants";
import type { Photo } from "@/types/types";

interface Props {
  language: string;
  video?: string;
  heroImage?: string;
  gallery: Photo[];
  court: "ACE_COURT" | "MOBILE_COURT" | "TOURNAMENT_COURT" | "PANORAMIC_FORCE_80_COURT" | "PANORAMIC_COURT" | "PANORAMIC_PLUS" | "CLUB_COURT" | "CLUB_PLUS" | "CLUB_FORCE_80_COURT" | "SINGLE_COURT" | "MINI_COURT";
}

// ============================================================================
// HELPER FUNCTIONS - Todo en el mismo archivo
// ============================================================================

const extractSections = (locale: any) => ({
  paint: locale.PAINT_SECTION,
  first: locale.FIRST_SECTION,
  benefits: locale.BENEFITS_SECTION,
  structure: locale.STRUCTURE_SECTION,
  sizing: locale.SIZING_SECTION,
  glass: locale.GLASS_SECTION,
  turf: locale.TURF_SECTION,
  lighting: locale.LIGHTING_SECTION,
  gallery: locale.GALLERY_SECTION,
  courts: locale.COURTS_SECTION,
  contact: locale.CONTACT_SECTION,
  installation: locale.INSTALLATION_SECTION,
});

const getFaqConfig = (court: string, i18n: any) => {
  const faqMapping: Record<string, string> = {
    'CLUB_COURT': 'COURT',
    'ACE_COURT': 'ACE',
    'MINI_COURT': 'MINI',
    'SINGLE_COURT': 'SINGLE',
    'CLUB_PLUS': 'PLUS',
    'CLUB_FORCE_80_COURT': 'CLUB_FORCE_80_COURT',
    'PANORAMIC_COURT': 'PANORAMIC_COURT',
    'PANORAMIC_PLUS': 'PANORAMIC_PLUS',
    'PANORAMIC_FORCE_80_COURT': 'PANORAMIC_FORCE_80_COURT',
  };

  const suffix = faqMapping[court];
  if (!suffix) return null;

  const faqSection = i18n.PAGES.HOME.FAQS_SECTION;
  
  return {
    items: faqSection[`QUESTIONS_${suffix}`],
    title: faqSection[`TITLE_${suffix}`],
    urlButton: faqSection.BUTTON.URL,
    buttonTitle: faqSection.BUTTON.TITLE,
    urlText: faqSection.BUTTON.TEXT,
  };
};

const getContactDescription = (court: string, language: string, defaultDescription?: string): string => {
  const aceDescriptions: Record<string, string> = {
    en: '<p>Ready to install a ACE padel court at your club? Contact Portico Sport today to speak with one of our specialists. We are committed to delivering high-quality padel courts that exceed your expectations. Whether you want to upgrade an existing facility or build a new one from scratch, we are here to help.</p>',
    es: '<p>¿Listo para instalar una pista ACE en tu club? Contacta hoy con Portico Sport y habla con uno de nuestros especialistas. Nos comprometemos a ofrecer pistas de pádel de alta calidad que superen tus expectativas. Tanto si quieres mejorar una instalación existente como construir una nueva desde cero, estamos aquí para ayudarte.</p>',
    fr: '<p>Prêt à installer un court de padel ACE dans votre club ? Contactez Portico Sport dès aujourd\'hui pour parler avec l\'un de nos spécialistes. Nous nous engageons à fournir des courts de padel de haute qualité qui dépassent vos attentes. Que vous souhaitiez améliorer une installation existante ou en construire une nouvelle, nous sommes là pour vous aider.</p>',
    de: '<p>Bereit, einen ACE-Padelplatz in Ihrem Club zu installieren? Kontaktieren Sie noch heute Portico Sport, um mit einem unserer Spezialisten zu sprechen. Wir engagieren uns dafür, hochwertige Padelplätze zu liefern, die Ihre Erwartungen übertreffen. Egal, ob Sie eine bestehende Anlage aufrüsten oder eine neue von Grund auf bauen möchten, wir sind für Sie da.</p>',
  };

  if (court === 'ACE_COURT') {
    return aceDescriptions[language] || aceDescriptions.en;
  }
  
  return defaultDescription || '';
};

const calculateImageCount = (images: any): number => {
  if (!images) return 0;
  return [images.FRONT, images.PERSPECTIVE, images.TOP].filter(Boolean).length;
};

const getLogoMargin = (imageCount: number): string => {
  return imageCount <= 2 
    ? 'lg:-mt-[360px] md:-mt-[200px] -mt-[150px]' 
    : 'mt-0';
};

// ============================================================================
// COMPONENT LOGIC
// ============================================================================

const { language, video, heroImage, court, gallery } = Astro.props;

// Inicialización de i18n y locale
const i18n = getI18N({ language });
const currentLocale = getCurrentLocale({ language });
const locale = i18n.PAGES[court];

// Extraer todas las secciones usando el helper
const sections = extractSections(locale);

// Preparar imágenes de características
const featureImages: Photo[] = [];
if (sections.paint?.IMAGES) {
  sections.paint.IMAGES.forEach((image: Photo) => {
    featureImages.push({
      id: image.id,
      src: image.src,
      alt: image.alt,
    });
  });
}

// Configuración de FAQs consolidada
const faqConfig = getFaqConfig(court, i18n);

// Cálculo de margen de logo
const imageCount = calculateImageCount(sections.first?.IMAGES);
const logoMargin = getLogoMargin(imageCount);

// Configuración de canchas compatibles
const title = locale.TITLE;
const isMobile = title === i18n.PAGES.MOBILE_COURT.TITLE;
const force80Title = i18n.PAGES.PANORAMIC_FORCE_80_COURT.TITLE;
const courts = courtsGrid(i18n);
const compatibleCourts = isMobile 
  ? courts.filter((item) => item.title !== title && item.title !== force80Title)
  : courts.filter((item) => item.title !== title && item.title !== i18n.PAGES.MOBILE_COURT.TITLE);

const isAceCourt = court === "ACE_COURT";
---

<Layout
  title={locale.SEO_TITLE}
  description={locale.SEO_DESCRIPTION}
  ogImage={locale.OG_IMG}
  currentLocale={currentLocale}
  language={language}
  robots="index,follow"
  bgImage={heroImage}
>
  <Fragment slot="head">
    {heroImage && <link rel="preload" as="image" href={heroImage} />}
    
    <!-- Structured Data para SEO -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": i18n.PAGES.HOME.ROUTE.BREADCRUMB,
          "item": `${Astro.site}${i18n.PAGES.HOME.ROUTE.URL}`
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": locale.NAME
        }
      ]
    })} />
  </Fragment>

  {video ? (
    <Video 
      language={language} 
      video={video} 
      classVideo="cp-elipse relative overflow-hidden"
    >
      <Section className="absolute z-10 inset-0 animate-fade-up flex flex-col justify-center items-center text-white px-4 text-center">
        <div class="flex flex-col items-center gap-4 w-full max-w-[1400px] text-center">
          <header class="pt-8 md:pt-20">
            {locale.SUBTITLE && (
              <Typography
                tag="p"
                className="text-sm mb-0"
                type="primary"
                size="large"
                text={locale.SUBTITLE}
                responsive
              />
            )}
            <Typography
              tag="h1"
              type="secondary"
              className="uppercase mb-3 font-bold text-xl md:text-3xl"
              text={locale.DETAIL_TITLE || locale.TITLE}
              responsive
            />
          </header>

          {locale.DESCRIPTION && (
            <Typography
              tag="div"
              className="text-sm md:text-lg px-2 md:px-6 lg:px-16 xl:px-24"
              text={locale.DESCRIPTION}
              responsive
            />
          )}

          <Button
            target="_self"
            className="xl:hidden mt-4 text-sm"
            url={sections.contact?.BUTTON?.URL || locale.CONTACT_SECTION?.BUTTON?.URL || "#contact"}
          >
            {locale.CONTACT_BUTTON}
          </Button>
        </div>
      </Section>
    </Video>
  ) : null}

  <main class="flex flex-col gradient-bg relative">
    <Breadcrumb
      crumbs={[
        { label: i18n.PAGES.HOME.ROUTE.BREADCRUMB, href: i18n.PAGES.HOME.ROUTE.URL },
        { label: locale.NAME, href: locale.ROUTE.URL },
      ]}
    />

    {sections.first && (
      <Section heading2={sections.first.TITLE}>
        <Typography
          tag="div"
          className="text-center"
          text={sections.first.DESCRIPTION}
          responsive
        />

        <div class={`section-renders gap-4 max-w-[1400px] my-16 mx-auto px-6 ${!sections.first.IMAGES.FRONT ? "flex items-center justify-center" : ""}`}>
          {sections.first.IMAGES.FRONT && (
            <img
              src={sections.first.IMAGES.FRONT.src}
              alt={sections.first.IMAGES.FRONT.alt}
              class="front"
              loading="lazy"
              width="800"
              height="600"
            />
          )}
          {sections.first.IMAGES.PERSPECTIVE && (
            <img
              src={sections.first.IMAGES.PERSPECTIVE.src}
              alt={sections.first.IMAGES.PERSPECTIVE.alt}
              class="perspective"
              loading="lazy"
              width="400"
              height="300"
            />
          )}
          {sections.first.IMAGES.TOP && (
            <img
              src={sections.first.IMAGES.TOP.src}
              alt={sections.first.IMAGES.TOP.alt}
              class="top"
              loading="lazy"
              width="400"
              height="300"
            />
          )}
        </div>
      </Section>
    )}

    <div class={logoMargin}>
      <NormativeLogos language={language} />
    </div>

    <div class="bg-slate-100 w-full">
      {sections.benefits ? (
        <BenefitsSection
          title={sections.benefits.TITLE}
          Benefits={sections.benefits.BENEFITS}
        />
      ) : null}
    </div>

    {sections.structure ? (
      <SectionInformation
        title={sections.structure.TITLE}
        image={sections.structure.IMAGE.src}
        subtitle={sections.structure.SUBTITLE}
        text={sections.structure.TEXT}
      />
    ) : null}

    {sections.sizing ? (
      <SizingSection
        id={sections.sizing.ID}
        description={sections.sizing.DESCRIPTION}
        title={sections.sizing.TITLE}
        imageSizing={sections.sizing.IMAGE}
        outdoorText={sections.sizing.OUTDOOR}
        indoorText={sections.sizing.INDOOR}
        outdoorTitle={sections.sizing.OUTDOOR_TITLE}
        indoorTitle={sections.sizing.INDOOR_TITLE}
      />
    ) : null}

    {sections.glass ? (
      <Section
        className="flex flex-col max-w-none p-0 lg:mb-0 border-b-4 border-white bg-slate-100"
        style="padding: 0; margin-left: 0; margin-right: 0;"
      >
        <div class="flex flex-col-reverse xl:flex-row max-w-none bg-gradient-to-b">
          <div class="w-full py-8 px-4 flex-1 md:px-8 text-black">
            <Typography tag="h2" className="mb-6 font-bold uppercase" text={sections.glass.TITLE} responsive />
            <Typography tag="p" className="mb-4 font-thin" text={sections.glass.SUBTITLE} responsive />
            <Typography tag="div" text={sections.glass.DESCRIPTION} responsive />
          </div>
          <div class="relative w-full flex-1">
            <img
              loading="lazy"
              draggable={false}
              id={sections.glass.IMAGE.id}
              src={sections.glass.IMAGE.src}
              alt={sections.glass.IMAGE.alt}
              class="relative object-cover w-full xl:max-w-[1024px] top-0 left-0 transition-opacity select-none pointer-events-none aspect-video xl:aspect-[16/14] xxl:aspect-[16/11] image-reverse"
              width="1024"
              height="768"
            />
          </div>
        </div>
      </Section>
    ) : null}

    {sections.paint ? (
      <Section className="flex flex-col max-w-none p-0 border-b-4 border-white" style="padding: 0; margin-left: 0; margin-right: 0;">
        <div class="flex flex-col xl:flex-row max-w-none">
          <div class="relative w-full flex-1">
            {featureImages.map((image, index) => (
              <img
                loading="lazy"
                draggable={false}
                id={image.id}
                src={image.src}
                alt={image.alt}
                class={`${index === 0 ? "relative" : "absolute"} object-cover w-full xl:max-w-[1024px] top-0 left-0 transition-opacity select-none pointer-events-none image aspect-[16/11] ${index === 0 ? "opacity-100" : "opacity-0"}`}
                width="1024"
                height="627"
              />
            ))}
          </div>
          <div class="w-full py-8 px-4 md:px-8 xl:-ml-72 flex-1 z-10">
            <Typography tag="h2" className="mb-6 font-bold uppercase" text={sections.paint.TITLE} responsive type="secondary"/>
            <Typography tag="div" className="mb-8" text={sections.paint.DESCRIPTION} responsive />
            <FeatureList list={sections.paint.LIST} />
            <Typography tag="div" className="mt-8" text={sections.paint.DESCRIPTION_DOS} responsive />
          </div>
        </div>
      </Section>
    ) : null}

    <div class="bg-slate-100 text-black">
      {sections.turf ? (
        <TurfSection
          language={language}
          image={sections.turf.IMAGE}
          subtitle={sections.turf.SUBTITLE}
          title={sections.turf.TITLE}
          description={sections.turf.DESCRIPTION}
          list={sections.turf.LIST}
          descriptionDos={sections.turf.DESCRIPTION_DOS}
        />
      ) : null}
    </div>

    {sections.lighting ? (
      <LightSection 
        title={sections.lighting.TITLE}
        subtitle={sections.lighting.SUBTITLE}
        list={sections.lighting.LIST}
        description={isAceCourt ? sections.lighting.MASTS_DESCRIPTION_ACE : sections.lighting.MASTS_DESCRIPTION}
        language={language}
        isAceCourt={isAceCourt}
      />
    ) : null}

    <div class="w-full pt-28 bg-gradient-to-br from-[#315A75] via-[#151a36] to-[#151a36]">
      {faqConfig ? (
        <SectionFaqs
          items={faqConfig.items}
          title={faqConfig.title}
          urlButton={faqConfig.urlButton}
          buttonTitle={faqConfig.buttonTitle}
          urlText={faqConfig.urlText}
        />
      ) : null}
    </div>

    {sections.gallery ? (
      <Gallery
        id={sections.gallery.ID}
        path={sections.gallery.PATH}
        offset={sections.gallery.OFFSET}
        photos={gallery}
        loadMoreText={sections.gallery.BUTTON_TEXT}
      />
    ) : null}

    {sections.courts ? (
      <SectionCourtsGrid 
        language={language} 
        courts={compatibleCourts} 
        heading={sections.courts.TITLE} 
        subheading={sections.courts.DESCRIPTION} 
      />
    ) : null}

    {sections.contact ? (
      <SectionContact
        hiddenSubject
        subject={sections.contact.SUBJECT}
        language={language}
        bgImage={sections.contact.BG_IMAGE}
        image={sections.contact.IMAGE}
        description={getContactDescription(court, language, sections.contact.DESCRIPTION)}
      />
    ) : null}
  </main>
</Layout>

<style>
  .section-renders {
    display: grid;
    grid-template-rows: repeat(2, 1fr);
    grid-template-columns: repeat(2, minmax(150px, 1fr));
    justify-items: center;
    align-items: center;
  }
  
  .front {
    grid-column: 1 / -1;
  }
  
  .section-renders img {
    transition: filter 0.3s ease-in-out;
  }

  .section-renders img:hover {
    filter: drop-shadow(1px 1px 10px rgb(183 228 253));
  }

  @media (min-width: 1280px) {
    .image {
      -webkit-mask: linear-gradient(90deg, transparent, white 0, white 30%, transparent);
      mask: linear-gradient(90deg, transparent, white 0, white 30%, transparent);
    }

    .image-reverse {
      -webkit-mask: linear-gradient(-90deg, transparent, white 0, white 30%, transparent);
      mask: linear-gradient(-90deg, transparent, white 0, white 30%, transparent);
    }
  }
</style>

<script define:vars={{ featureImages }}>
  // Carrusel de imágenes optimizado
  if (featureImages && featureImages.length > 1) {
    let currentIndex = 0;
    
    const transition = () => {
      const currentImage = featureImages[currentIndex];
      const nextIndex = (currentIndex + 1) % featureImages.length;
      const nextImage = featureImages[nextIndex];

      const currentEl = document.getElementById(currentImage.id);
      const nextEl = document.getElementById(nextImage.id);

      if (currentEl && nextEl) {
        currentEl.classList.replace('opacity-100', 'opacity-0');
        nextEl.classList.replace('opacity-0', 'opacity-100');
      }

      currentIndex = nextIndex;
    };

    // Cambiar cada 3 segundos
    const intervalId = setInterval(transition, 3000);

    // Limpiar al salir de la página
    window.addEventListener('beforeunload', () => {
      clearInterval(intervalId);
    });
  }
</script>
